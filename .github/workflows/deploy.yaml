name: Deploy Config

on:
    push:
        branches:
            - "main"
    check_suite:
        types: [completed]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@main

            - name: Tailscale
              uses: tailscale/github-action@main
              with:
                  oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
                  oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
                  tags: tag:ci

            - name: Install Nix
              uses: DeterminateSystems/nix-installer-action@main

            - uses: cachix/cachix-action@v15
              with:
                  name: volodiapg
                  authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

            - name: Install SSH key
              uses: shimataro/ssh-key-action@v2
              with:
                  key: ${{ secrets.SSH_KEY }}
                  known_hosts: ${{ secrets.KNOWN_HOSTS }}
                  if_key_exists: fail # replace / ignore / fail; optional (defaults to fail)

            # - name: Check
            #   run: |
            #       set -euxo pipefail
            #       nix flake check

            - name: Build and deploy
              run: |
                  set -euxo pipefail
                  nix run github:serokell/deploy-rs -- --targets .#dell .#home-server
